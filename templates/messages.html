{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>Messages</h1>
    <a href="{{ url_for('add_message') }}" class="btn btn-primary">New Message</a>
</div>

<div class="table">
    <div class="table-header">
        <div>Title</div>
        <div>From</div>
        <div>Date</div>
        <div>Priority</div>
        <div>Actions</div>
    </div>
    
    {% for message in messages %}
    <div class="table-row {% if message.is_urgent %}urgent{% endif %}">
        <div><strong>{{ message.title }}</strong></div>
        <div>{{ message.sender.username }} ({{ message.sender.role }})</div>
        <div>{{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}</div>
        <div>{% if message.is_urgent %}<span style="color: red;">URGENT</span>{% else %}Normal{% endif %}</div>
        <div class="actions">
            <button class="btn btn-secondary" onclick="showMessage({{ message.id }})">View</button>
            {% if message.can_delete(current_user) %}
            <a href="{{ url_for('delete_message', message_id=message.id) }}" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this message?')">Delete</a>
            {% endif %}
        </div>
    </div>
    
    <!-- Message Details Modal -->
    <div id="message-{{ message.id }}" style="display: none; background: white; padding: 1rem; margin: 0.5rem 0; border-radius: 4px; border-left: 4px solid #3498db;">
        <h4>{{ message.title }}</h4>
        <p><strong>From:</strong> {{ message.sender.username }} ({{ message.sender.role }})</p>
        <p><strong>Date:</strong> {{ message.timestamp.strftime('%Y-%m-%d %H:%M') }}</p>
        <p><strong>Priority:</strong> {% if message.is_urgent %}<span style="color: red;">URGENT</span>{% else %}Normal{% endif %}</p>
        <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
            {{ message.content|replace('\n', '<br>')|safe }}
        </div>
        <button class="btn btn-secondary" onclick="hideMessage({{ message.id }})" style="margin-top: 1rem;">Close</button>
    </div>
    {% else %}
    <div class="table-row">
        <div style="grid-column: 1 / -1; text-align: center; padding: 2rem;">
            No messages yet. <a href="{{ url_for('add_message') }}">Send the first message</a>
        </div>
    </div>
    {% endfor %}
</div>

<script>
function showMessage(messageId) {
    // Hide all message details first
    var allMessages = document.querySelectorAll('[id^="message-"]');
    allMessages.forEach(function(msg) {
        msg.style.display = 'none';
    });
    
    // Show the selected message
    var messageDiv = document.getElementById('message-' + messageId);
    if (messageDiv) {
        messageDiv.style.display = 'block';
    }
}

function hideMessage(messageId) {
    var messageDiv = document.getElementById('message-' + messageId);
    if (messageDiv) {
        messageDiv.style.display = 'none';
    }
}
</script>
{% endblock %}